<!DOCTYPE html>
<html lang="en">

<head>
  <title>Mouse Spring</title>
  <meta charset="utf-8">
  <script src="libs/tiny.debug.js"></script>
  <script src="../dist/Tiny.Physics.P2.debug.js"></script>
  <script src="utils/DebugLine.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2,minimum-scale=1,user-scalable=1">
  <style type="text/css">
    body,
    html,
    canvas {
      padding: 0;
      margin: 0;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0)
    }
  </style>
</head>

<body>

  <script>
    var config = {
      showFPS: true, // 显示帧频
      dpi: 1, // 分辨率
      renderOptions: {
        backgroundColor: 0x2a3145 // 画布背景色
      }
    };

    var app = new Tiny.Application(config);
    Tiny.Physics.P2.startSystem(app, {
      gravity: [0, 0]
    });

    app.physics.p2.gravity.y = 100;

    function setTitle(title, container) {
      var title = new Tiny.Text(title, {
        fontSize: '18px',
        fill: 'white',
      });

      title.position.set(Tiny.WIN_SIZE.width / 2, 30);
      title.anchor.set(0.5, 0);
      container.addChild(title);
    }

    var resources = Tiny.Loader.resources;
    var sprite;
    function init() {
      container = new Tiny.Container();

      var line = new DebugLine();

      setTitle('Mouse Spring', container);

      //  设置回弹系数 增加小人落到地上的回跳效果
      app.physics.p2.restitution = 0.8;

      ant = new Tiny.Sprite(resources['ant'].texture);
      ant.position.x = Tiny.WIN_SIZE.width / 2;
      ant.position.y = 100;

      // 加入物理系统
      app.physics.p2.enable(ant, true);
      ant.body.fixedRotation = true;
      ant.body.setCircle(20);

      container.addChild(ant);


      var mouseCursor = new Tiny.Sprite(resources['cursor'].texture);
      mouseCursor.position.x = Tiny.WIN_SIZE.width / 2;
      mouseCursor.position.y = 100;
      container.addChild(mouseCursor);

      app.physics.p2.enable(mouseCursor);

      mouseCursor.body.static = true;
      mouseCursor.body.setCircle(10);
      mouseCursor.body.data.shapes[0].sensor = true;

      container.setEventEnabled(true);

      let dragging = false;
      let drawLine = false;
      let mouseSpring = null;
      line.visible = false;
      mouseCursor.visible = false;
      container.mousedown = container.touchstart = function (data) {
        // data.stopPropagation();
        dragging = true;
        var pos = data.data.getLocalPosition(container);
        var bodies = app.physics.p2.hitTest(pos, [ant.body]);
        if (bodies.length) {
          mouseSpring = app.physics.p2.createSpring(mouseCursor, bodies[0], 0, 30, 1);
          // line.setTo(ant.x, ant.y, mouseCursor.x, mouseCursor.y);
          line.setTo(0, 0, 0, 0);
          drawLine = true;
          line.visible = true;
          mouseCursor.visible = true;
        }
      };

      container.mouseup = container.mouseupoutside
        = container.touchend = container.touchendoutside = function (data) {
          dragging = false;
          drawLine = false;
          line.visible = false;
          mouseCursor.visible = false;
          app.physics.p2.removeSpring(mouseSpring);
        };

      container.mousemove = container.touchmove = function (data) {
        var pos = data.data.getLocalPosition(container);
        mouseCursor.body.x = pos.x;
        mouseCursor.body.y = pos.y;
      }


      container.addChild(line);

      app.run(container);
      app.onUpdate(function () {
        line.setTo(ant.x, ant.y, mouseCursor.x, mouseCursor.y);
      })
    }

    Tiny.Loader
      .add('ant', 'images/super_ant.png')
      .add('cursor', 'images/enemy-bullet.png')
      .load(function (a, b) {
        init();
      });
  </script>
</body>

</html>
